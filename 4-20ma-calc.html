<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=3.0, user-scalable=yes">
    <title>CTi 4-20mA Calculator</title>
    
    <!-- PWA Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="4-20mA Calc">
    <meta name="theme-color" content="#facc15">
    <meta name="description" content="Professional 4-20mA loop calculator with gas sensor presets">
    
    <!-- Web App Manifest -->
    <link rel="manifest" href="manifest.json">
    
    <!-- Apple Touch Icons -->
    <link rel="apple-touch-icon" sizes="180x180" href="icon-180.png">
    <link rel="apple-touch-icon" sizes="152x152" href="icon-152.png">
    <link rel="apple-touch-icon" sizes="144x144" href="icon-144.png">
    <link rel="apple-touch-icon" sizes="120x120" href="icon-120.png">
    <link rel="icon" type="image/png" sizes="192x192" href="icon-192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="icon-512.png">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --base-font-size: 16px;
            --scale-factor: 1;
        }

        html {
            font-size: var(--base-font-size);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #d1d5db 0%, #e5e7eb 50%, #d1d5db 100%);
            min-height: 100vh;
            padding: 1rem;
            touch-action: manipulation;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -khtml-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        @font-face {
            font-family: 'Segment';
            src: url('seg.otf') format('opentype');
        }

        .container {
            max-width: min(384px, 100%);
            margin: 0 auto;
            position: relative;
        }

        /* Preset Overlay */
        .preset-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 50;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 16px;
        }

        .preset-modal {
            background: white;
            border-radius: 8px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            max-width: min(384px, 90vw);
            width: 90%;
            max-height: 80vh;
            overflow: hidden;
        }

        .preset-header {
            background: #facc15;
            padding: clamp(0.75rem, 3vw, 1rem);
            border-bottom: 1px solid #e5e7eb;
        }

        .preset-header h3 {
            font-weight: bold;
            color: black;
            text-align: center;
            font-size: clamp(0.9rem, 3vw, 1.125rem);
        }

        .preset-list {
            overflow-y: auto;
            max-height: 60vh;
            padding: 8px;
        }

        .preset-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            text-align: left;
            padding: clamp(0.625rem, 2.5vw, 0.75rem);
            border: none;
            background: none;
            width: 100%;
            border-bottom: 1px solid #f3f4f6;
            cursor: pointer;
        }

        .preset-item.selected {
            background: #e0f2fe;
        }

        .preset-label {
            font-family: monospace;
            font-weight: bold;
            font-size: clamp(0.75rem, 2.5vw, 0.875rem);
            color: black;
            flex-shrink: 0;
        }

        .preset-desc {
            font-size: clamp(0.65rem, 2vw, 0.75rem);
            color: #6b7280;
            text-align: left !important;
        }

        .preset-footer {
            padding: clamp(0.75rem, 3vw, 1rem);
            border-top: 1px solid #e5e7eb;
            background: #f9fafb;
        }

        .close-btn {
            width: 100%;
            background: #4b5563;
            color: white;
            border: none;
            padding: clamp(0.5rem, 2vw, 0.625rem) clamp(0.75rem, 3vw, 1rem);
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
            font-size: clamp(0.875rem, 2.5vw, 1rem);
        }

        .close-btn:hover {
            background: #374151;
        }

        /* Main Device */
        .fluke-body {
            background: linear-gradient(135deg, rgba(255,255,255,0.2) 0%, transparent 50%), linear-gradient(to bottom, #eece2b, #facc15, #eab308);
            border-radius: 24px 24px 0 0;
            padding: clamp(1rem, 4vw, 1.5rem);
            box-shadow: 0 20px 40px rgba(0,0,0,0.3), inset 0 1px 0 rgba(255,255,255,0.3), inset 0 -1px 0 rgba(0,0,0,0.2);
            border: 4px solid #111827;
            position: relative;
        }





        .fluke-text {
            color: #facc15;
            font-weight: 900;
            font-size: clamp(0.9rem, 3vw, 1.125rem);
            letter-spacing: 2px;
            text-shadow: 0 1px 2px rgba(0,0,0,0.5);
        }

        .model-text {
            color: black;
            font-weight: bold;
            font-size: clamp(0.75rem, 2.5vw, 0.875rem);
            text-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }

        .subtitle {
            color: black;
            font-size: clamp(0.7rem, 2vw, 0.75rem);
            opacity: 0.8;
        }

        /* LCD Bezel */
        .lcd-bezel {
            background: linear-gradient(to bottom, #1f2937, #111827);
            border-radius: 12px;
            padding: clamp(0.75rem, 3vw, 1rem);
            margin-bottom: clamp(1rem, 4vw, 1.5rem);
            box-shadow: inset 0 4px 8px rgba(0,0,0,0.6), 0 2px 4px rgba(0,0,0,0.3);
            border: 2px solid #000;
        }

        /* Modern LCD Screen */
        .lcd-screen {
            background: linear-gradient(to bottom, #e6eff8, #dae1f0);
            border-radius: 8px;
            padding: clamp(0.75rem, 3vw, 0.875rem) clamp(1rem, 4vw, 1.5rem) clamp(0.5rem, 2vw, 0.75rem);
            position: relative;
            overflow: hidden;
            min-height: clamp(180px, 40vw, 220px);
            border: 2px solid #d1d5db;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.1), 0 1px 2px rgba(255,255,255,0.8);
        }

        .lcd-content {
            position: relative;
            z-index: 10;
        }

        .header-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: clamp(0.65rem, 2vw, 0.75rem);
            padding: 0.25rem 0.5rem;
            border-radius: 2px;
            background: #374151;
            color: white;
            font-weight: normal;
            margin-bottom: clamp(0.75rem, 3vw, 1rem);
            font-family: Verdana, sans-serif;
        }
        
        .header-bar svg {
            vertical-align: middle;
            display: inline-block;
        }
        
        .header-bar span {
            display: flex;
            align-items: center;
        }

        .main-reading {
            text-align: center;
            padding: 10px 0;
        }

        .reading-value {
            font-size: clamp(2.5rem, 12vw, 4rem);
            font-weight: bold;
            font-family: 'Segment', monospace;
            letter-spacing: 2px;
            color: black;
            margin-bottom: 0.5rem;
        }

        .reading-unit {
            font-size: clamp(1.2rem, 5vw, 1.5rem);
            margin-left: 0.5rem;
        }

        .percentage {
            font-size: clamp(0.9rem, 3.5vw, 1.125rem);
            color: #6b7280;
            font-weight: 500;
        }

        .scale-container {
            padding: 0 8px;
            margin-bottom: 8px;
        }
        


        .scale-labels {
            display: flex;
            justify-content: space-between;
            font-size: clamp(0.7rem, 2.5vw, 0.875rem);
            margin-bottom: 0.5rem;
            color: #6b7280;
            font-weight: 500;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            border-radius: 0px;
            background: #e5e7eb;
            border: 1px solid #d1d5db;
            position: relative;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            border-radius: 0px;
            background: #9ca3af;
            transition: width 0.7s ease;
            width: 0%;
            -webkit-mask-image: repeating-linear-gradient(to right, black 0, black 5px, transparent 5px, transparent 6px);
            mask-image: repeating-linear-gradient(to right, black 0, black 5px, transparent 5px, transparent 6px);
        }



        .power-off {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            text-align: center;
        }

        .power-off-text {
            font-size: 32px;
            font-family: monospace;
            color: #9ca3af;
            font-weight: bold;
        }

        .power-off-label {
            font-size: 14px;
            margin-top: 8px;
            font-weight: 500;
            color: #6b7280;
        }

        .lcd-reflection {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, transparent 30%, rgba(255,255,255,0.3) 50%, transparent 70%);
            opacity: 0.2;
            pointer-events: none;
            transition: all 0.3s ease;
        }

        /* Enhanced glare effect for mobile devices */
        @media screen and (max-width: 768px) {
            .lcd-reflection {
                background: linear-gradient(var(--glare-angle, 45deg), 
                    transparent 20%, 
                    rgba(255,255,255,0.1) 30%, 
                    rgba(255,255,255,0.4) 50%, 
                    rgba(255,255,255,0.1) 70%, 
                    transparent 80%);
                opacity: var(--glare-opacity, 0.2);
                transform: translateX(var(--glare-x, 0px)) translateY(var(--glare-y, 0px));
            }

            .lcd-reflection.glare-active {
                opacity: 0.4;
                background: linear-gradient(var(--glare-angle, 45deg), 
                    transparent 10%, 
                    rgba(255,255,255,0.2) 20%, 
                    rgba(255,255,255,0.6) 40%, 
                    rgba(255,255,255,0.8) 50%, 
                    rgba(255,255,255,0.6) 60%, 
                    rgba(255,255,255,0.2) 80%, 
                    transparent 90%);
            }
        }

        /* Buttons */
        .button-row {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 12px;
            margin-bottom: 0px;
        }

        .button-row.presets {
            margin-bottom: 0px;
        }

        .btn {
            min-height: clamp(2.5rem, 8vw, 2.625rem);
            font-weight: bold;
            font-size: clamp(0.75rem, 2.5vw, 0.875rem);
            padding: 0.5rem;
            border: 2px solid #111827;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.15s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.25rem;
            touch-action: manipulation;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
            position: relative;
        }

        .btn.preset {
            min-height: clamp(2.25rem, 7vw, 2.5rem);
            font-size: clamp(0.65rem, 2vw, 0.75rem);
        }

        .btn {
            transition: transform 0.1s ease, box-shadow 0.1s ease;
        }

        .btn:active {
            box-shadow: inset 0 3px 6px rgba(0,0,0,0.5),
                        inset 0 1px 2px rgba(0,0,0,0.3);
            transform: translateY(1px);
        }
        
        /* Better icon alignment and realistic text effects */
        .btn svg {
            display: block;
            margin: 0 auto;
            filter: drop-shadow(0 1px 0 rgba(255,255,255,0.2)) drop-shadow(0 -1px 0 rgba(0,0,0,0.3));
        }
        
        .btn span {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .btn {
            text-shadow: 0 1px 0 rgba(255,255,255,0.2), 0 -1px 0 rgba(0,0,0,0.3);
        }

        .btn.power {
            background: linear-gradient(to bottom, #ef4444, #dc2626);
            color: white;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3), 
                        inset 0 1px 0 rgba(255,255,255,0.3),
                        inset 0 -1px 0 rgba(0,0,0,0.2),
                        inset 1px 0 0 rgba(255,255,255,0.1),
                        inset -1px 0 0 rgba(0,0,0,0.1);
            text-shadow: 0 1px 0 rgba(0,0,0,0.5), 0 -1px 0 rgba(255,255,255,0.1);
        }
        
        .btn.power svg {
            filter: drop-shadow(0 1px 0 rgba(0,0,0,0.5)) drop-shadow(0 -1px 0 rgba(255,255,255,0.1));
        }

        .btn.power.off {
            background: linear-gradient(to bottom, #22c55e, #16a34a);
        }

        .btn.power:hover {
            background: linear-gradient(to bottom, #dc2626, #b91c1c);
        }

        .btn.power.off:hover {
            background: linear-gradient(to bottom, #16a34a, #15803d);
        }

        .btn.clear, .btn.preset-btn {
            background: linear-gradient(to bottom, #4b5563, #1f2937);
            color: #facc15;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3), 
                        inset 0 1px 0 rgba(255,255,255,0.2),
                        inset 0 -1px 0 rgba(0,0,0,0.3),
                        inset 1px 0 0 rgba(255,255,255,0.1),
                        inset -1px 0 0 rgba(0,0,0,0.1);
            text-shadow: 0 1px 0 rgba(0,0,0,0.6), 0 -1px 0 rgba(255,255,255,0.1);
        }
        
        .btn.preset-btn svg {
            filter: drop-shadow(0 1px 0 rgba(0,0,0,0.6)) drop-shadow(0 -1px 0 rgba(255,255,255,0.1));
        }

        .btn.clear:hover, .btn.preset-btn:hover {
            background: linear-gradient(to bottom, #6b7280, #374151);
        }

        .btn.test {
            background: linear-gradient(to bottom, #3b82f6, #1d4ed8);
            color: white;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3), 
                        inset 0 1px 0 rgba(255,255,255,0.3),
                        inset 0 -1px 0 rgba(0,0,0,0.2),
                        inset 1px 0 0 rgba(255,255,255,0.1),
                        inset -1px 0 0 rgba(0,0,0,0.1);
        }

        .btn.test:hover {
            background: linear-gradient(to bottom, #2563eb, #1e40af);
        }

        .btn.more {
            background: linear-gradient(to bottom, #f97316, #ea580c);
            color: white;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3), inset 0 1px 0 rgba(255,255,255,0.1);
        }

        .btn.more:hover {
            background: linear-gradient(to bottom, #ea580c, #c2410c);
        }

        /* Lower Case */
        .lower-case {
            background: linear-gradient(135deg, rgba(255,255,255,0.1) 0%, transparent 50%), linear-gradient(to bottom, #374151, #1f2937, #111827);
            border-radius: 0 0 24px 24px;
            padding: clamp(1rem, 4vw, 1.5rem);
            box-shadow: 0 20px 40px rgba(0,0,0,0.4), inset 0 1px 0 rgba(255,255,255,0.1);
            border: 4px solid #111827;
            border-top: none;
            position: relative;
        }

        .input-group {
            margin-bottom: clamp(0.75rem, 3vw, 1rem);
        }

        .input-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: clamp(0.75rem, 3vw, 1rem);
        }

        .input-label {
            display: block;
            color: #facc15;
            font-size: clamp(0.75rem, 2.5vw, 0.875rem);
            font-weight: bold;
            margin-bottom: 0.5rem;
            letter-spacing: 1px;
            text-shadow: 0 1px 2px rgba(0,0,0,0.5);
            text-align: center;
        }

        .input-label.secondary {
            color: #d1d5db;
            font-size: clamp(0.65rem, 2vw, 0.75rem);
            text-align: center;
        }

        .input-label.tertiary {
            color: #9ca3af;
            text-align: center;
        }

        .input-field {
            min-height: clamp(3rem, 10vw, 4rem);
            font-size: clamp(1rem, 4vw, 1.25rem);
            text-align: center;
            font-family: monospace;
            letter-spacing: 1px;
            background: linear-gradient(to bottom, #000, #1f2937);
            border: 2px solid #facc15;
            color: #facc15;
            border-radius: 4px;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.6), 0 1px 0 rgba(255,255,255,0.1);
            transition: all 0.2s;
            width: 100%;
            touch-action: manipulation;
            padding: 0.5rem 0.5rem;
            box-sizing: border-box;
        }

        .input-field.small {
            min-height: clamp(2.5rem, 8vw, 3rem);
            font-size: clamp(0.875rem, 3vw, 1rem);
            border: 1px solid #6b7280;
            color: #d1d5db;
        }

        /* Hide iOS toolbar and improve mobile input */
        .input-field {
            -webkit-user-select: text;
            user-select: text;
            -webkit-touch-callout: none;
            -webkit-tap-highlight-color: transparent;
        }

        /* Hide iOS cut/copy/paste toolbar */
        .input-field:focus {
            -webkit-user-select: text;
            user-select: text;
        }

        /* Prevent iOS zoom on focus */
        @supports (-webkit-touch-callout: none) {
            .input-field {
                font-size: max(16px, clamp(1rem, 4vw, 1.25rem));
            }
            .input-field.small {
                font-size: max(16px, clamp(0.875rem, 3vw, 1rem));
            }
        }

        .input-field.tertiary {
            border: 1px solid #4b5563;
            color: #9ca3af;
        }

        .input-field:focus {
            outline: none;
            border-color: #fde047;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.6), 0 0 0 4px rgba(253, 224, 71, 0.2);
        }

        .input-field:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Hide default browser stepper controls */
        .input-field::-webkit-outer-spin-button,
        .input-field::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        .input-field[type=number] {
            -moz-appearance: textfield;
            appearance: textfield;
        }

        .input-wrapper {
            position: relative;
            display: flex;
            align-items: center;
            gap: clamp(0.375rem, 2vw, 0.5rem);
        }

        .input-wrapper .input-field {
            flex: 1;
            min-width: 0; /* Allow shrinking below content size */
        }

        .input-wrapper.small .input-field {
            flex: 1;
            min-width: 0;
        }

        .stepper-btn {
            min-width: clamp(2.5rem, 8vw, 2.75rem);
            min-height: clamp(3rem, 10vw, 4rem);
            font-size: clamp(1.25rem, 5vw, 1.5rem);
            font-weight: bold;
            border: 2px solid #facc15;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.15s;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(to bottom, #4b5563, #1f2937);
            color: #facc15;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3), 
                        inset 0 1px 0 rgba(255,255,255,0.2),
                        inset 0 -1px 0 rgba(0,0,0,0.3),
                        inset 1px 0 0 rgba(255,255,255,0.1),
                        inset -1px 0 0 rgba(0,0,0,0.1);
            user-select: none;
            touch-action: manipulation;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -webkit-tap-highlight-color: transparent;
            padding: 0.5rem;
            flex-shrink: 0;
        }

        .stepper-btn.small {
            min-width: clamp(2.25rem, 7vw, 2.5rem);
            min-height: clamp(2.5rem, 8vw, 3rem);
            font-size: clamp(1rem, 4vw, 1.125rem);
            border: 1px solid #6b7280;
            color: #d1d5db;
        }

        .stepper-btn:hover {
            background: linear-gradient(to bottom, #6b7280, #374151);
        }

        .stepper-btn {
            transition: transform 0.1s ease, box-shadow 0.1s ease;
        }

        .stepper-btn:active {
            box-shadow: inset 0 3px 6px rgba(0,0,0,0.5),
                        inset 0 1px 2px rgba(0,0,0,0.3);
            transform: translateY(1px);
        }

        .stepper-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .info-panel {
            margin-top: clamp(1rem, 4vw, 1.5rem);
            padding-top: clamp(0.75rem, 3vw, 1rem);
            border-top: 1px solid #4b5563;
            background: linear-gradient(to right, transparent, rgba(55, 65, 81, 0.3), transparent);
            border-radius: 4px;
            padding: clamp(0.375rem, 2vw, 0.5rem);
        }

        .info-text {
            text-align: center;
            font-size: clamp(0.625rem, 2vw, 0.6875rem);
            color: #9ca3af;
            font-family: monospace;
            letter-spacing: 0px;
        }

        .icon {
            width: 16px;
            height: 16px;
            display: inline-block;
            vertical-align: middle;
        }

        .hidden {
            display: none !important;
        }

        /* Help Modal Styles */
        .help-modal {
            position: fixed;
            top: 0px;
            left: 0px;
            right: 0px;
            bottom: 0px;
            background: rgba(0,0,0,0.5);
            z-index: 9999999;
            transition: all 0.2s ease;
            pointer-events: none;
            opacity: 0;
            visibility: hidden;
        }

        .help-modal.show {
            opacity: 1;
            visibility: visible;
            pointer-events: auto;
        }

        .help-msgbox {
            position: absolute;
            top: 0;
            bottom: 0;
            left: 0;
            right: 0;
            width: 90%;
            max-width: 600px;
            margin: auto;
            pointer-events: auto;
            font-size: 18px;
            line-height: 1.5;
        }

        .help-msgbox-inner {
            position: relative;
            top: 10%;
            background: white;
            border-radius: 8px;
            padding: 1.5rem;
            box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25);
            max-height: 80vh;
            overflow-y: auto;
            line-height: 1.5;
        }

        .help-modal h1 {
            font-size: 1.4rem;
            font-weight: 700;
            margin-bottom: 1rem;
            color: #115EA3;
            text-align: center;
            border-bottom: 2px solid #facc15;
            padding-bottom: 0.5rem;
        }

        .formula-section {
            margin-bottom: 1rem;
        }

        .formula-section h3 {
            font-size: 1rem;
            font-weight: 600;
            color: #374151;
            margin-bottom: 0.4rem;
        }

        .formula-display {
            font-family: 'Courier New', monospace;
            background: #f8fafc;
            padding: 0.75rem;
            border-radius: 6px;
            border: 1px solid #e2e8f0;
            color: #1e293b;
            font-size: 0.9rem;
            letter-spacing: 0.3px;
            text-align: center;
            margin-bottom: 0.2rem;
        }

        .variables-section {
            margin-top: 1.2rem;
            padding-top: 1rem;
            border-top: 1px solid #e5e7eb;
        }

        .variables-section h3 {
            font-size: 1rem;
            font-weight: 600;
            color: #374151;
            margin-bottom: 0.6rem;
        }

        .variable-list {
            display: grid;
            gap: 0.3rem;
        }

        .variable-item {
            display: flex;
            align-items: center;
            font-size: 0.9rem;
            color: #4b5563;
        }

        .variable-name {
            font-weight: 700;
            color: #115EA3;
            background: #f0f9ff;
            padding: 0.2rem 0.4rem;
            border-radius: 4px;
            margin-right: 0.5rem;
            min-width: 1.3rem;
            text-align: center;
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
        }

        .help-footer {
            text-align: center;
            margin-top: 1.2rem;
            padding-top: 1rem;
            border-top: 1px solid #e5e7eb;
        }

        .help-close-btn {
            background: #115EA3;
            color: white;
            border: none;
            padding: 0.6rem 1.5rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.95rem;
            font-weight: 600;
            transition: background-color 0.2s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .help-close-btn:hover {
            background: #0d4a7a;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }

        .help-close-btn:active {
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        /* Help modal responsive adjustments */
        @media screen and (max-width: 480px) {
            .help-msgbox-inner {
                padding: 1.2rem;
                top: 5%;
            }
            
            .help-modal h1 {
                font-size: 1.3rem;
                margin-bottom: 0.8rem;
            }
            
            .formula-section {
                margin-bottom: 0.8rem;
            }
            
            .formula-display {
                padding: 0.6rem;
                font-size: 0.85rem;
            }
            
            .variables-section {
                margin-top: 1rem;
                padding-top: 0.8rem;
            }
            
            .variable-item {
                font-size: 0.85rem;
            }
            
            .help-footer {
                margin-top: 1rem;
                padding-top: 0.8rem;
            }
        }

        /* Segmented Control for Input Type */
        .segmented-control {
            display: flex;
            width: 100%;
            border-radius: 6px;
            background: linear-gradient(to bottom, #000, #1f2937);
            border: 1px solid #4b5563;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.6);
            padding: 4px;
        }

        .segmented-control input[type="radio"] {
            display: none;
        }

        .segmented-control label {
            flex: 1;
            text-align: center;
            padding: clamp(0.5rem, 2vw, 0.625rem);
            color: #d1d5db;
            font-weight: bold;
            font-size: clamp(0.7rem, 2.2vw, 0.8rem);
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            border-radius: 4px;
            text-shadow: 0 1px 2px rgba(0,0,0,0.5);
            user-select: none;
            background: rgba(55, 65, 81, 0.3);
        }

        .segmented-control label:hover {
            color: #f3f4f6;
            background: rgba(75, 85, 99, 0.5);
        }

        .segmented-control input[type="radio"]:checked + label {
            background: linear-gradient(to bottom, #3b82f6, #1d4ed8) !important;
            color: white !important;
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.4), inset 0 1px 2px rgba(255,255,255,0.2);
            text-shadow: 0 1px 2px rgba(0,0,0,0.3);
            transform: translateY(-1px);
        }

        .segmented-control label:active,
        .segmented-control input[type="radio"]:checked + label:active {
            background: linear-gradient(to bottom, #1d4ed8, #1e40af) !important;
            color: white !important;
        }

        /* Media Queries for Better Mobile Support */
        
        /* Very small phones (320px - 375px) */
        @media screen and (max-width: 375px) {
            :root {
                --base-font-size: 14px;
            }
            
            body {
                padding: 0.5rem;
            }
            
            .fluke-body, .lower-case {
                border-width: 2px;
            }
            
            .btn svg {
                width: 20px;
                height: 20px;
            }
            
            .reading-value {
                font-size: clamp(2rem, 10vw, 3rem);
            }
            
            .stepper-btn {
                min-width: clamp(2.25rem, 12vw, 2.75rem);
            }
            
            .input-field {
                min-height: clamp(2.5rem, 12vw, 3rem);
                font-size: max(16px, 1rem);
            }
            
            .input-field.small {
                min-height: clamp(2.25rem, 10vw, 2.75rem);
            }
            
            .button-row {
                gap: 0.5rem;
            }
            
            .preset-modal {
                width: 95%;
                max-width: 95vw;
            }
            
            .help-msgbox {
                width: 95%;
            }
            
            .help-msgbox-inner {
                padding: 1rem;
                top: 5%;
            }
            
            /* All stepper buttons remain visible on all screen sizes */
        }
        
        /* Small phones (376px - 480px) */
        @media screen and (min-width: 376px) and (max-width: 480px) {
            :root {
                --base-font-size: 15px;
            }
            
            .reading-value {
                font-size: clamp(2.25rem, 11vw, 3.5rem);
            }
        }
        
        /* Medium phones and small tablets (481px - 768px) */
        @media screen and (min-width: 481px) and (max-width: 768px) {
            :root {
                --base-font-size: 16px;
            }
            
            .container {
                max-width: 420px;
            }
        }
        
        /* Landscape orientation on small devices */
        @media screen and (max-height: 500px) and (orientation: landscape) {
            body {
                padding: 0.5rem;
            }
            
            .lcd-screen {
                min-height: clamp(140px, 30vw, 180px);
            }
            
            .reading-value {
                font-size: clamp(1.75rem, 8vw, 2.5rem);
            }
            
            .input-field {
                min-height: clamp(2.25rem, 8vw, 2.75rem);
            }
            
            .stepper-btn {
                min-height: clamp(2.25rem, 8vw, 2.75rem);
            }
            
            .btn {
                min-height: clamp(2rem, 6vw, 2.25rem);
            }
            
            .info-panel {
                margin-top: 0.5rem;
                padding-top: 0.5rem;
            }
        }
        
        /* High DPI screens */
        @media screen and (-webkit-min-device-pixel-ratio: 2),
               screen and (min-resolution: 192dpi) {
            .fluke-body, .lower-case, .lcd-bezel {
                border-width: 3px;
            }
        }
        
        /* Touch device optimizations */
        @media (hover: none) and (pointer: coarse) {
            .btn, .stepper-btn {
                min-height: 44px; /* iOS minimum touch target */
                min-width: 44px;
            }
            
            .input-field {
                min-height: 44px;
            }
        }
        
        /* Reduce animations on low-end devices */
        @media (prefers-reduced-motion: reduce) {
            * {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Help Modal -->
        <div id="help-modal" class="help-modal" onclick="closeHelp()">
            <div class="help-msgbox">
                <div class="help-msgbox-inner" onclick="event.stopPropagation()">
                    <h1>Conversions</h1>
                    
                    <div class="formula-section">
                        <h3 id="help-title-1"></h3>
                        <div id="help-formula-1" class="formula-display"></div>
                    </div>
                    
                    <div class="formula-section">
                        <h3 id="help-title-2"></h3>
                        <div id="help-formula-2" class="formula-display"></div>
                    </div>
                    
                    <div class="variables-section">
                        <h3>Variables:</h3>
                        <div class="variable-list">
                            <div class="variable-item">
                                <span class="variable-name" id="help-var-1">V</span> = Value in Unit of Measure
                            </div>
                            <div class="variable-item">
                                <span class="variable-name" id="help-var-2">R</span> = Signal Value
                            </div>
                            <div class="variable-item">
                                <span class="variable-name">S</span> = Span in Unit of Measure
                            </div>
                            <div class="variable-item">
                                <span class="variable-name">Z</span> = Zero in Unit of Measure
                            </div>
                        </div>
                    </div>

                    <div class="help-footer">
                        <button class="help-close-btn" onclick="closeHelp()">Close</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Preset Overlay -->
        <div class="preset-overlay" id="presetOverlay">
            <div class="preset-modal">
                <div class="preset-header">
                    <h3>Unit of Measure</h3>
                </div>
                <div class="preset-list" id="presetList">
     
                </div>
                <div class="preset-footer">
                    <button class="close-btn" onclick="closePresets()">Close</button>
                </div>
            </div>
        </div>

        <!-- Main Device -->
        <div class="fluke-body">
      

            <!-- LCD Display -->
            <div class="lcd-bezel">
                <div class="lcd-screen">
                    <div class="lcd-content" id="lcdContent">
                    </div>
                    <div class="lcd-reflection"></div>
                </div>
            </div>

            <!-- Function Buttons -->
            <div class="button-row">
                <button class="btn power" id="powerBtn" onclick="clearAll()">
                    <span><svg xmlns="http://www.w3.org/2000/svg" x="0px" y="0px" width="30" height="30" viewBox="0,0,256,256" style="transform: translateY(px);">
                        <g fill="#ffffff" fill-rule="nonzero" stroke="none" stroke-width="1" stroke-linecap="butt" stroke-linejoin="miter" stroke-miterlimit="10" stroke-dasharray="" stroke-dashoffset="0" font-family="none" font-weight="none" font-size="none" text-anchor="none" style="mix-blend-mode: normal"><g transform="scale(8.53333,8.53333)"><path d="M27,6h-18.448c-0.989,0 -1.913,0.486 -2.472,1.301l-4.904,7.133c-0.234,0.341 -0.234,0.792 0,1.133l4.904,7.133c0.559,0.814 1.483,1.3 2.472,1.3h18.448c1.103,0 2,-0.897 2,-2v-14c0,-1.103 -0.897,-2 -2,-2zM21.707,18.293c0.391,0.391 0.391,1.023 0,1.414c-0.195,0.195 -0.451,0.293 -0.707,0.293c-0.256,0 -0.512,-0.098 -0.707,-0.293l-3.293,-3.293l-3.293,3.293c-0.195,0.195 -0.451,0.293 -0.707,0.293c-0.256,0 -0.512,-0.098 -0.707,-0.293c-0.391,-0.391 -0.391,-1.023 0,-1.414l3.293,-3.293l-3.293,-3.293c-0.391,-0.391 -0.391,-1.023 0,-1.414c0.391,-0.391 1.023,-0.391 1.414,0l3.293,3.293l3.293,-3.293c0.391,-0.391 1.023,-0.391 1.414,0c0.391,0.391 0.391,1.023 0,1.414l-3.293,3.293z"></path></g></g>
                        </svg></span>
                </button>
                <button class="btn preset-btn" onclick="showHelp()">
                    <svg xmlns="http://www.w3.org/2000/svg" x="0px" y="0px" width="24" height="24" viewBox="0,0,256,256">
                        <g fill="#ffffff" fill-rule="nonzero" stroke="none" stroke-width="1" stroke-linecap="butt" stroke-linejoin="miter" stroke-miterlimit="10" stroke-dasharray="" stroke-dashoffset="0" font-family="none" font-weight="none" font-size="none" text-anchor="none" style="mix-blend-mode: normal"><g transform="scale(10.66667,10.66667)"><path d="M12,2c-5.52,0 -10,4.48 -10,10c0,5.52 4.48,10 10,10c5.52,0 10,-4.48 10,-10c0,-5.52 -4.48,-10 -10,-10zM13,19h-2v-2h2zM15.07,11.25l-0.9,0.92c-0.72,0.73 -1.17,1.33 -1.17,2.83h-2v-0.5c0,-1.1 0.45,-2.1 1.17,-2.83l1.24,-1.26c0.37,-0.36 0.59,-0.86 0.59,-1.41c0,-1.1 -0.9,-2 -2,-2c-1.1,0 -2,0.9 -2,2h-2c0,-2.21 1.79,-4 4,-4c2.21,0 4,1.79 4,4c0,0.88 -0.36,1.68 -0.93,2.25z"></path></g></g>
                        </svg>
                </button>  
                <button class="btn test" onclick="showPresets()">
                    UNIT
                </button>            
            </div>


        </div>

        <!-- Lower Case -->
        <div class="lower-case">
    

            <!-- Process Value Input -->
            <div class="input-group">
                <label class="input-label" id="valueLabel">
                    VALUE in PPM
                </label>
                <div class="input-wrapper">
                    <button class="stepper-btn" onclick="stepValue('valueInput', -1)">&lt;</button>
                    <input type="number" class="input-field" id="valueInput" placeholder="Value" oninput="calculateFromValue()" onclick="this.select()" inputmode="numeric" pattern="[0-9]*" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false">
                    <button class="stepper-btn" onclick="stepValue('valueInput', 1)">&gt;</button>
                </div>
            </div>
            <!-- Signal Input -->
            <div class="input-group">
                <label class="input-label" id="signalInputLabel">
                     SIGNAL (mV)
                </label>
                <div class="input-wrapper">
                    <button class="stepper-btn" onclick="stepValue('signalInput', -1)">&lt;</button>
                    <input type="number" class="input-field" id="signalInput" placeholder="mV" oninput="calculateFromSignal()" onclick="this.select()" inputmode="numeric" pattern="[0-9]*" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false">
                    <button class="stepper-btn" onclick="stepValue('signalInput', 1)">&gt;</button>
                </div>
            </div>


            <!-- Zero and Span -->
            <div class="input-group">
                <div class="input-row">
                    <div>
                        <label class="input-label secondary">ZERO</label>
                        <div class="input-wrapper small">
                            <button class="stepper-btn small" onclick="stepValue('zeroInput', -1)">&lt;</button>
                            <input type="number" class="input-field small" id="zeroInput" value="0" oninput="calculateFromValue()" onclick="this.select()" inputmode="numeric" pattern="[0-9]*" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false">
                            <button class="stepper-btn small" onclick="stepValue('zeroInput', 1)">&gt;</button>
                        </div>
                    </div>
                    <div>
                        <label class="input-label secondary">SPAN</label>
                        <div class="input-wrapper small">
                            <button class="stepper-btn small" onclick="stepValue('spanInput', -1)">&lt;</button>
                            <input type="number" class="input-field small" id="spanInput" value="100" oninput="calculateFromValue()" onclick="this.select()" inputmode="numeric" pattern="[0-9]*" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false">
                            <button class="stepper-btn small" onclick="stepValue('spanInput', 1)">&gt;</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Input Type Switch -->
            <div class="input-group">
                <label class="input-label secondary">INPUT TYPE</label>
                <div class="segmented-control">
                    <input type="radio" id="type-ma" name="inputType" value="ma" checked>
                    <label for="type-ma">4-20mA</label>
                    <input type="radio" id="type-mv10" name="inputType" value="mv10">
                    <label for="type-mv10">40-200mV</label>
                    <input type="radio" id="type-mv100" name="inputType" value="mv100">
                    <label for="type-mv100">400-2000mV</label>
                </div>
            </div>

            <!-- Test Resistance -->
            <div class="input-group hidden">
                <label class="input-label tertiary">Test R (mV) • 40mV = 4mA</label>
                <input type="number" class="input-field small tertiary" id="resistanceInput" value="1" onclick="this.select()" inputmode="numeric" pattern="[0-9]*" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false">
            </div>

            <!-- Info Panel -->
            <div class="info-panel">
                <div class="info-text">R = ((V - 0) / (100 - 0)) × 160 + 40</div>
            </div>
        </div>
    </div>

    <script>
        // State
        let isOn = true;
        let result = null;
        let currentUom = 'PPM';
        let currentSensor = '';
        let currentGasShort = '';
        let lastInput = 'value';
        let inputType = 'ma'; // 'ma', 'mv10', 'mv100'

        // Signal configurations
        const signalConfig = {
            ma:    { min: 4,    max: 20,   span: 16,    unit: 'mA',  precision: 2, name: '4-20mA' },
            mv10:  { min: 40,   max: 200,  span: 160,   unit: 'mV',  precision: 1, name: '40-200mV (10Ω)' },
            mv100: { min: 400,  max: 2000, span: 1600,  unit: 'mV', precision: 0, name: '400-2000mV (100Ω)' }
        };

        // Presets data
        const presets = [
            { "uom": "PPM", "name": "Parts Per Million" },
            { "uom": "%", "name": "Percent" },
            { "uom": "%LEL", "name": "Lower Explosive Limit" },
            { "uom": "°F", "name": "Fahrenheit" },
            { "uom": "°C", "name": "Celsius" },
            { "uom": "PSI", "name": "Pounds per Square Inch" }
        ];

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            populatePresets();
            setInputType(inputType);
            updateDisplay();
            calculateFromValue();

            document.querySelectorAll('input[name="inputType"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    setInputType(this.value);
                });
            });
        });

        // Set input type
        function setInputType(type) {
            inputType = type;
            const config = signalConfig[type];
            const signalInputLabel = document.getElementById('signalInputLabel');
            const signalInput = document.getElementById('signalInput');

            signalInputLabel.innerHTML = `SIGNAL (${config.unit})`;
            signalInput.placeholder = config.unit;
            
            clearAll(); // Clear inputs when mode changes
        }

        // Calculate from Process Value
        function calculateFromValue() {
            if (!isOn) {
                result = null;
                updateDisplay();
                return;
            }
            lastInput = 'value';

            const zero = parseFloat(document.getElementById('zeroInput').value) || 0;
            const upperValue = parseFloat(document.getElementById('spanInput').value) || 100;
            const value = parseFloat(document.getElementById('valueInput').value);
            const span = upperValue - zero;

            if (!isNaN(value) && span !== 0) {
                const percentage = (value - zero) / span;
                result = 4 + percentage * 16;
                
                const config = signalConfig[inputType];
                const signalValue = config.min + percentage * config.span;
                document.getElementById('signalInput').value = signalValue.toFixed(config.precision);
            } else {
                result = null;
                document.getElementById('signalInput').value = '';
            }

            updateDisplay();
        }

        // Calculate from Signal (mA or mV)
        function calculateFromSignal() {
            if (!isOn) {
                result = null;
                updateDisplay();
                return;
            }
            lastInput = 'signal';

            const zero = parseFloat(document.getElementById('zeroInput').value) || 0;
            const upperValue = parseFloat(document.getElementById('spanInput').value) || 100;
            const signalValue = parseFloat(document.getElementById('signalInput').value);
            const span = upperValue - zero;
            const config = signalConfig[inputType];
            
            if (!isNaN(signalValue) && span !== 0) {
                const percentage = (signalValue - config.min) / config.span;
                const value = (percentage * span) + zero;
                result = 4 + (percentage * 16);
                document.getElementById('valueInput').value = value.toFixed(1);
            } else {
                document.getElementById('valueInput').value = '';
                result = null;
            }

            updateDisplay();
        }


        // Update LCD display
        function updateDisplay() {
            const lcdContent = document.getElementById('lcdContent');
            const valueLabel = document.getElementById('valueLabel');
            const zero = parseFloat(document.getElementById('zeroInput').value) || 0;
            const upperValue = parseFloat(document.getElementById('spanInput').value) || 100;
            const value = parseFloat(document.getElementById('valueInput').value);
            
            // Update the dynamic label
            valueLabel.textContent = `VALUE in ${currentUom}`;
            
            if (isOn) {
                const percentage = result ? (((result - 4) / 16) * 100).toFixed(1) : "0.0";
                const progressWidth = result ? Math.max(0, Math.min(100, ((result - 4) / 16) * 100)) : 0;
                


                lcdContent.innerHTML = `
                    <div class="header-bar">
                                                 <svg id="Layer_1" data-name="Layer 1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 46.083 21.879" style="height: 1.1em; vertical-align: middle;">
  <defs>
    <style>
      .cls-1 {
        fill: #fff;
      }
    </style>
  </defs>
  <g>
    <polygon class="cls-1" points="44.455 4.8 46.083 .02 40.371 0 38.75 4.8 44.455 4.8"/>
    <polygon class="cls-1" points="38.477 5.608 34.145 18.434 39.81 18.434 44.179 5.608 38.477 5.608"/>
  </g>
  <path class="cls-1" d="M18.623,13.695h-8.278c-.694,0-1.323-.092-1.888-.275-.566-.184-1.054-.441-1.464-.772-.411-.331-.73-.73-.958-1.199-.228-.468-.342-.987-.342-1.557,0-.735.164-1.41.493-2.025.328-.615.775-1.153,1.341-1.612.565-.459,1.227-.817,1.984-1.075.757-.257,1.555-.386,2.395-.386h7.315L20.839.005l-8.086-.005-.333.006c-1.628.03-3.169.279-4.621.751-1.551.506-2.901,1.213-4.05,2.122-1.15.91-2.062,1.998-2.737,3.265-.675,1.267-1.013,2.655-1.013,4.161,0,1.157.228,2.232.684,3.224.456.992,1.099,1.851,1.929,2.577.83.726,1.834,1.295,3.01,1.708,1.177.413,2.477.62,3.9.62h7.499l1.601-4.739Z"/>
  <polygon class="cls-1" points="21.687 .015 20.067 4.795 27.54 4.795 21.74 21.879 27.204 21.879 33.031 4.795 37.887 4.795 39.506 .01 21.687 .015"/>
</svg>
                        <span>${signalConfig[inputType].name} Calc</span>
                    </div>
                    <div class="main-reading">
                        <div class="reading-value">
                            ${!isNaN(value) ? value.toFixed(1) : "0.0"}
                        </div>
                        <div class="percentage">${currentUom}</div>
                    </div>
                    <div class="scale-container">
                        <div class="scale-labels">
                            <span>${zero}</span>
                            <span>${(zero + (upperValue - zero) * 0.25).toFixed(zero % 1 === 0 && upperValue % 1 === 0 ? 0 : 1)}</span>
                            <span>${(zero + (upperValue - zero) * 0.5).toFixed(zero % 1 === 0 && upperValue % 1 === 0 ? 0 : 1)}</span>
                            <span>${(zero + (upperValue - zero) * 0.75).toFixed(zero % 1 === 0 && upperValue % 1 === 0 ? 0 : 1)}</span>
                            <span>${upperValue}</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${progressWidth}%"></div>
                        </div>
                    </div>
                `;
            } else {
                lcdContent.innerHTML = `
                    <div class="power-off">
                        <div>
                            <div class="power-off-text">---</div>
                            <div class="power-off-label">Power Off</div>
                        </div>
                    </div>
                `;
            }

            const infoText = document.querySelector('.info-text');
            let formula = '';
            const config = signalConfig[inputType];
            const z = parseFloat(document.getElementById('zeroInput').value) || 0;
            const s_upper = parseFloat(document.getElementById('spanInput').value) || 100;
            const signalChar = inputType === 'ma' ? 'I' : 'R';
            const valueChar = 'V';

            if (lastInput === 'value') {
                const v_val = parseFloat(document.getElementById('valueInput').value) || 0;
                formula = `${signalChar} = ((${v_val.toFixed(1)} - ${z.toFixed(1)}) / (${s_upper.toFixed(1)} - ${z.toFixed(1)})) * ${config.span} + ${config.min}`;
            } else { // lastInput === 'signal'
                const r_val = parseFloat(document.getElementById('signalInput').value) || 0;
                formula = `${valueChar} = ((${r_val.toFixed(config.precision)} - ${config.min}) / ${config.span}) * (${s_upper.toFixed(1)} - ${z.toFixed(1)}) + ${z.toFixed(1)}`;
            }
            infoText.textContent = formula;
        }

        // Clear all values
        function clearAll() {
            document.getElementById('valueInput').value = '';
            document.getElementById('signalInput').value = '';
            lastInput = 'value';
            result = null;
            updateDisplay();
        }

        // Test value
        function testValue() {
            const zero = parseFloat(document.getElementById('zeroInput').value) || 0;
            const upperValue = parseFloat(document.getElementById('spanInput').value) || 100;
            const fiftyPercentValue = zero + (upperValue - zero) * 0.5;
            document.getElementById('valueInput').value = fiftyPercentValue.toFixed(1);
            calculateFromValue();
        }

        // Set preset
        function setPreset(zero, span, uom, sensor, gas_short) {
            document.getElementById('zeroInput').value = zero;
            document.getElementById('spanInput').value = span;
            currentUom = uom || '%';
            currentSensor = sensor || '';
            currentGasShort = gas_short || '';
            calculateFromValue();
        }

        // Show presets
        function showPresets() {
            document.getElementById('presetOverlay').style.display = 'flex';
        }

        // Close presets
        function closePresets() {
            document.getElementById('presetOverlay').style.display = 'none';
        }

        // Populate presets list
        function populatePresets() {
            const presetList = document.getElementById('presetList');
            presetList.innerHTML = presets.map(preset => {
                const isSelected = preset.uom === currentUom;
                return `
                <button class="preset-item ${isSelected ? 'selected' : ''}" onclick='applyPreset("${preset.uom}")'>
                    <div class="preset-label">${preset.uom}</div>
                    <div class="preset-desc">${preset.name}</div>
                </button>
            `}).join('');
        }

        // Apply preset
        function applyPreset(uom) {
            currentUom = uom;
            document.getElementById('zeroInput').value = 0;
            document.getElementById('spanInput').value = 100;
            currentSensor = '';
            currentGasShort = '';
            calculateFromValue();
            populatePresets();
            closePresets();
        }

        // Close preset overlay when clicking outside
        document.getElementById('presetOverlay').addEventListener('click', function(e) {
            if (e.target === this) {
                closePresets();
            }
        });

        // Show help modal
        function showHelp() {
            const config = signalConfig[inputType];
            const z = parseFloat(document.getElementById('zeroInput').value) || 0;
            const s_upper = parseFloat(document.getElementById('spanInput').value) || 100;
            const signalChar = inputType === 'ma' ? 'I' : 'R';
            const valueChar = 'V';

            // Update dynamic titles
            document.getElementById('help-title-1').textContent = `Convert ${config.name} to ${currentUom}:`;
            document.getElementById('help-title-2').textContent = `Convert ${currentUom} to ${config.name}:`;
            
            // Create clean, readable formulas with actual values
            const formula1 = `${valueChar} = ((${signalChar} - ${config.min}) ÷ ${config.span}) × (${s_upper} - ${z}) + ${z}`;
            const formula2 = `${signalChar} = ((${valueChar} - ${z}) ÷ (${s_upper} - ${z})) × ${config.span} + ${config.min}`;
            
            document.getElementById('help-formula-1').textContent = formula1;
            document.getElementById('help-formula-2').textContent = formula2;
            
            // Update variable names
            document.getElementById('help-var-1').textContent = valueChar;
            document.getElementById('help-var-2').textContent = signalChar;

            document.getElementById('help-modal').classList.add('show');
        }

        // Close help modal
        function closeHelp() {
            document.getElementById('help-modal').classList.remove('show');
        }

        // Register service worker for PWA
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                navigator.serviceWorker.register('./sw.js')
                    .then(function(registration) {
                        console.log('ServiceWorker registration successful');
                    })
                    .catch(function(err) {
                        console.log('ServiceWorker registration failed: ', err);
                    });
            });
        }

        // Step value function for stepper buttons
        function stepValue(inputId, direction) {
            const input = document.getElementById(inputId);
            const currentValue = parseFloat(input.value) || 0;
            
            let stepSize = 1;
            if (inputId === 'signalInput') {
                if (inputType === 'ma') stepSize = 0.1;
                else if (inputType === 'mv10') stepSize = 1;
                else if (inputType === 'mv100') stepSize = 10;
            } else if (inputId === 'valueInput') {
                const zero = parseFloat(document.getElementById('zeroInput').value) || 0;
                const span = parseFloat(document.getElementById('spanInput').value) || 100;
                const range = Math.abs(span - zero);
                stepSize = range > 100 ? 10 : (range > 10 ? 1 : 0.1);
            }
            
            let precision = 0;
            if (stepSize < 1) precision = 1;
            if (inputType === 'ma' && inputId === 'signalInput') precision = 2;

            const newValue = currentValue + (direction * stepSize);
            input.value = newValue.toFixed(precision);
            
            // Trigger the appropriate calculation
            if (inputId === 'valueInput' || inputId === 'zeroInput' || inputId === 'spanInput') {
                calculateFromValue();
            } else if (inputId === 'signalInput') {
                calculateFromSignal();
            }
        }

        // Enhanced LCD glare effect for mobile devices
        function initLCDGlare() {
            if (window.DeviceOrientationEvent && /Mobile|Android|iPhone|iPad/i.test(navigator.userAgent)) {
                const lcdReflection = document.querySelector('.lcd-reflection');
                let glareTimeout;
                
                function updateGlare(alpha, beta, gamma) {
                    // Normalize values and create glare effect
                    const normalizedBeta = Math.max(-45, Math.min(45, beta || 0));
                    const normalizedGamma = Math.max(-45, Math.min(45, gamma || 0));
                    
                    // Calculate glare intensity based on tilt
                    const tiltIntensity = Math.sqrt(normalizedBeta * normalizedBeta + normalizedGamma * normalizedGamma) / 45;
                    const glareIntensity = Math.min(tiltIntensity * 0.6, 0.5);
                    
                    // Calculate glare angle based on device orientation
                    const glareAngle = Math.atan2(normalizedGamma, normalizedBeta) * (180 / Math.PI) + 45;
                    
                    // Calculate subtle offset for glare position
                    const offsetX = normalizedGamma * 0.5;
                    const offsetY = normalizedBeta * 0.5;
                    
                    if (lcdReflection) {
                        // Set CSS custom properties for glare effect
                        lcdReflection.style.setProperty('--glare-angle', `${glareAngle}deg`);
                        lcdReflection.style.setProperty('--glare-opacity', glareIntensity);
                        lcdReflection.style.setProperty('--glare-x', `${offsetX}px`);
                        lcdReflection.style.setProperty('--glare-y', `${offsetY}px`);
                        
                        // Add active class for enhanced glare when tilted
                        if (tiltIntensity > 0.2) {
                            lcdReflection.classList.add('glare-active');
                        } else {
                            lcdReflection.classList.remove('glare-active');
                        }
                    }
                }
                
                // Handle device orientation change
                function handleOrientation(event) {
                    clearTimeout(glareTimeout);
                    glareTimeout = setTimeout(() => {
                        updateGlare(event.alpha, event.beta, event.gamma);
                    }, 16); // ~60fps
                }
                
                // Request permission for iOS 13+
                if (typeof DeviceOrientationEvent.requestPermission === 'function') {
                    DeviceOrientationEvent.requestPermission()
                        .then(response => {
                            if (response === 'granted') {
                                window.addEventListener('deviceorientation', handleOrientation, { passive: true });
                            }
                        })
                        .catch(console.error);
                } else {
                    // For Android and older iOS versions
                    window.addEventListener('deviceorientation', handleOrientation, { passive: true });
                }
            }
        }

        // Initialize glare effect when DOM is loaded
        document.addEventListener('DOMContentLoaded', initLCDGlare);



        function preventStickyButtons() {
            // Prevent buttons from getting stuck in pressed state
            const buttons = document.querySelectorAll('button, .stepper-btn, .btn, .segmented-control input[type="radio"]');
            
            buttons.forEach(button => {
                // Prevent buttons from getting stuck by removing focus immediately
                button.addEventListener('click', function(e) {
                    // Force immediate blur and state reset
                    setTimeout(() => {
                        this.blur();
                        this.classList.remove('active');
                    }, 10);
                }, { passive: true });
                
                // Handle touch events more aggressively
                button.addEventListener('touchstart', function(e) {
                    // Clear any existing active state
                    this.classList.remove('active');
                }, { passive: true });
                
                // Ensure button state is cleared after touch
                button.addEventListener('touchend', function(e) {
                    // Immediate and delayed clearing
                    this.blur();
                    this.classList.remove('active');
                    setTimeout(() => {
                        this.blur();
                        this.classList.remove('active');
                    }, 50);
                }, { passive: true });
                
                // Handle mouse events to prevent sticky state
                button.addEventListener('mouseup', function(e) {
                    setTimeout(() => {
                        this.blur();
                        this.classList.remove('active');
                    }, 10);
                }, { passive: true });
                
                // More aggressive focus management
                button.addEventListener('focus', function(e) {
                    // Immediately clear focus after a short delay
                    setTimeout(() => {
                        if (document.activeElement === this) {
                            this.blur();
                        }
                    }, 50);
                });
                
                // Handle mousedown to ensure clean state
                button.addEventListener('mousedown', function(e) {
                    this.classList.remove('active');
                }, { passive: true });
            });

            // Handle preset list items when they're created
            const presetObserver = new MutationObserver((mutations) => {
                mutations.forEach((mutation) => {
                    mutation.addedNodes.forEach((node) => {
                        if (node.nodeType === 1 && node.classList && node.classList.contains('preset-item')) {
                            // Prevent sticky state for preset items
                            node.addEventListener('click', function(e) {
                                setTimeout(() => {
                                    this.blur();
                                    this.classList.remove('active');
                                }, 10);
                            }, { passive: true });
                            
                            node.addEventListener('touchend', function(e) {
                                this.blur();
                                this.classList.remove('active');
                                setTimeout(() => {
                                    this.blur();
                                    this.classList.remove('active');
                                }, 50);
                            }, { passive: true });
                            
                            node.addEventListener('mouseup', function(e) {
                                setTimeout(() => {
                                    this.blur();
                                    this.classList.remove('active');
                                }, 10);
                            }, { passive: true });
                        }
                    });
                });
            });

            // Observe the preset list for dynamically added items
            const presetList = document.getElementById('presetList');
            if (presetList) {
                presetObserver.observe(presetList, { childList: true, subtree: true });
            }
        }

        // Initialize button behavior to prevent sticky buttons
        document.addEventListener('DOMContentLoaded', function() {
            // Add a small delay to ensure all elements are loaded
            setTimeout(preventStickyButtons, 100);
        });
    </script>
</body>
</html>
